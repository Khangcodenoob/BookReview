{% extends 'base.html' %}
{% block title %}Viết đánh giá - {{ book.title }}{% endblock %}
{% block content %}

<!-- Debug Information (remove in production) -->
{% if book %}
<div>
  Debug Info: {{ book.title }}
</div>
{% else %}
<div style="background: #ffebee; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
  <strong>Error:</strong> No book data found!
</div>
{% endif %}

<!-- Review Header -->
<div class="review-header" style="background: linear-gradient(135deg, var(--primary), var(--accent)); color: #06210e; padding: 30px 0; margin: -20px -20px 30px -20px; border-radius: 0 0 20px 20px; position: relative; overflow: hidden;">
  <div class="container" style="position: relative; z-index: 1;">
    <div class="review-header-content" style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
      <!-- Book Cover -->
      <div class="book-cover" style="width: 80px; height: 120px; border-radius: 8px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.2); flex-shrink: 0;">
        <img src="{{ book.cover_url or url_for('static', filename='placeholder.jpg') }}" alt="{{ book.title }}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='{{ url_for('static', filename='placeholder.jpg') }}'">
      </div>
      
      <!-- Book Info -->
      <div class="book-info" style="flex: 1; min-width: 200px;">
        <h1 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">{{ book.title }}</h1>
        <p style="margin: 0 0 12px 0; font-size: 16px; opacity: 0.9;">{{ book.author }}</p>
        <div class="book-meta" style="display: flex; gap: 16px; flex-wrap: wrap;">
          {% if book.genre %}
          <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">{{ book.genre }}</span>
          {% endif %}
          <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">📖 Đánh giá sách</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Review Form -->
<div class="review-form-container" style="max-width: 800px; margin: 0 auto;">
  <form method="post" action="{{ url_for('create_review', book_id=book.id) }}" class="review-form" id="reviewForm">
    
    <!-- Reviewer Section -->
    <div class="form-section" style="background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow);">
      <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #06210e; font-size: 18px;">
          👤
        </div>
        <h3 style="margin: 0; color: var(--text); font-size: 18px; font-weight: 600;">Thông tin người đánh giá</h3>
      </div>
      
      <div class="form-group">
        <label for="reviewer" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">
          Tên của bạn <span style="color: #ef4444;">*</span>
  </label>
        <input type="text" id="reviewer" name="reviewer" required 
               style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 16px; transition: all 0.2s;"
               placeholder="Nhập tên của bạn..."
               onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(34, 197, 94, 0.1)'"
               onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
        <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Tên sẽ hiển thị công khai trên đánh giá</small>
      </div>
    </div>

    <!-- Rating Section -->
    <div class="form-section" style="background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow);">
      <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #06210e; font-size: 18px;">
          ⭐
        </div>
        <h3 style="margin: 0; color: var(--text); font-size: 18px; font-weight: 600;">Đánh giá của bạn</h3>
      </div>
      
      <div class="rating-container" style="text-align: center;">
        <div class="star-rating" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 16px;">
          {% for i in range(1, 6) %}
          <button type="button" class="star-btn" data-rating="{{ i }}" 
                  style="width: 48px; height: 48px; border: none; background: none; cursor: pointer; font-size: 32px; color: #d1d5db; transition: all 0.2s; padding: 0;"
                  onmouseover="highlightStars({{ i }})"
                  onmouseout="resetStars()"
                  onclick="selectRating({{ i }})">
            ★
          </button>
      {% endfor %}
        </div>
        
        <div class="rating-feedback" id="ratingFeedback" style="margin-bottom: 16px; font-size: 16px; font-weight: 600; color: var(--text); min-height: 24px;">
          Nhấn vào ngôi sao để đánh giá
        </div>
        
        <input type="hidden" id="rating" name="rating" required>
        
        <div class="rating-descriptions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 20px;">
          <div class="rating-desc" data-rating="1" style="padding: 12px; background: var(--bg); border-radius: 8px; text-align: center; opacity: 0.5; transition: all 0.2s;">
            <div style="font-size: 20px; margin-bottom: 4px;">😞</div>
            <div style="font-size: 12px; font-weight: 600;">Rất tệ</div>
          </div>
          <div class="rating-desc" data-rating="2" style="padding: 12px; background: var(--bg); border-radius: 8px; text-align: center; opacity: 0.5; transition: all 0.2s;">
            <div style="font-size: 20px; margin-bottom: 4px;">😕</div>
            <div style="font-size: 12px; font-weight: 600;">Tệ</div>
          </div>
          <div class="rating-desc" data-rating="3" style="padding: 12px; background: var(--bg); border-radius: 8px; text-align: center; opacity: 0.5; transition: all 0.2s;">
            <div style="font-size: 20px; margin-bottom: 4px;">😐</div>
            <div style="font-size: 12px; font-weight: 600;">Bình thường</div>
          </div>
          <div class="rating-desc" data-rating="4" style="padding: 12px; background: var(--bg); border-radius: 8px; text-align: center; opacity: 0.5; transition: all 0.2s;">
            <div style="font-size: 20px; margin-bottom: 4px;">😊</div>
            <div style="font-size: 12px; font-weight: 600;">Tốt</div>
          </div>
          <div class="rating-desc" data-rating="5" style="padding: 12px; background: var(--bg); border-radius: 8px; text-align: center; opacity: 0.5; transition: all 0.2s;">
            <div style="font-size: 20px; margin-bottom: 4px;">🤩</div>
            <div style="font-size: 12px; font-weight: 600;">Xuất sắc</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Book Display Section -->
    <div class="form-section" style="background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow);">
      <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; background: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
          📖
        </div>
        <h3 style="margin: 0; color: var(--text); font-size: 18px; font-weight: 600;">Sách bạn đang đánh giá</h3>
      </div>
      
      <div class="book-display" style="display: flex; align-items: center; gap: 20px; padding: 20px; background: var(--bg); border-radius: 12px; border: 1px solid var(--border);">
        <div class="book-cover-large" style="width: 100px; height: 150px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-shrink: 0;">
          <img src="{{ book.cover_url or url_for('static', filename='placeholder.jpg') }}" alt="{{ book.title }}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='{{ url_for('static', filename='placeholder.jpg') }}'">
        </div>
        
        <div class="book-details" style="flex: 1;">
          <h4 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; color: var(--text);">{{ book.title }}</h4>
          <p style="margin: 0 0 12px 0; font-size: 16px; color: var(--muted); font-weight: 500;">{{ book.author }}</p>
          
          <div class="book-meta-details" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
            {% if book.genre %}
            <span style="background: var(--primary); color: #06210e; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">{{ book.genre }}</span>
            {% endif %}
            {% if book.publisher %}
            <span style="background: var(--accent); color: #06210e; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">{{ book.publisher }}</span>
            {% endif %}
          </div>
          
          {% if book.description %}
          <div class="book-description" style="color: var(--text); font-size: 14px; line-height: 1.5; max-height: 60px; overflow: hidden; position: relative;">
            {{ book.description[:200] }}{% if book.description|length > 200 %}...{% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Review Content Section -->
    <div class="form-section" style="background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow);">
      <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
          ✍️
        </div>
        <h3 style="margin: 0; color: var(--text); font-size: 18px; font-weight: 600;">Nội dung đánh giá</h3>
      </div>
      
      <div class="form-group">
        <label for="content" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">
          Chia sẻ cảm nhận của bạn
        </label>
        <textarea id="content" name="content" rows="6" 
                  style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 16px; line-height: 1.5; resize: vertical; min-height: 120px; transition: all 0.2s; font-family: inherit;"
                  placeholder="Hãy chia sẻ những điều bạn thích hoặc không thích về cuốn sách này. Đánh giá chi tiết sẽ giúp người khác hiểu rõ hơn về cuốn sách..."
                  onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(34, 197, 94, 0.1)'"
                  onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'"
                  oninput="updateCharCount()"></textarea>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
          <small style="color: var(--muted); font-size: 12px;">
            💡 Mẹo: Hãy chia sẻ về cốt truyện, nhân vật, văn phong, hoặc những bài học bạn rút ra được
          </small>
          <div style="color: var(--muted); font-size: 12px;">
            <span id="charCount">0</span>/1000 ký tự
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Features -->
    <div class="form-section" style="background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow);">
      <div class="section-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
          🏷️
        </div>
        <h3 style="margin: 0; color: var(--text); font-size: 18px; font-weight: 600;">Thông tin bổ sung</h3>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div class="form-group">
          <label for="reading-status" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">
            Trạng thái đọc
          </label>
          <select id="reading-status" name="reading_status" 
                  style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 16px; transition: all 0.2s;">
            <option value="completed">✅ Đã đọc xong</option>
            <option value="reading">📖 Đang đọc</option>
            <option value="partially">📑 Đọc một phần</option>
    </select>
        </div>
        
        <div class="form-group">
          <label for="recommend" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">
            Có khuyến nghị không?
  </label>
          <select id="recommend" name="recommend" 
                  style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 16px; transition: all 0.2s;">
            <option value="yes">👍 Có khuyến nghị</option>
            <option value="maybe">🤔 Có thể</option>
            <option value="no">👎 Không khuyến nghị</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions" style="display: flex; gap: 16px; justify-content: center; margin-top: 30px;">
      <button type="submit" class="btn btn-primary" 
              style="padding: 16px 32px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; min-width: 160px; justify-content: center;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22,4 12,14.01 9,11.01"/>
        </svg>
        Gửi đánh giá
      </button>
      <a href="{{ url_for('book_detail', book_id=book.id) }}" class="btn btn-secondary"
         style="padding: 16px 32px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; min-width: 160px; justify-content: center; text-decoration: none;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Hủy bỏ
      </a>
  </div>
</form>
</div>

<script>
// Star Rating System
let selectedRating = 0;
const starButtons = document.querySelectorAll('.star-btn');
const ratingInput = document.getElementById('rating');
const ratingFeedback = document.getElementById('ratingFeedback');
const ratingDescriptions = document.querySelectorAll('.rating-desc');

const ratingTexts = {
  1: '😞 Rất tệ - Không hài lòng',
  2: '😕 Tệ - Thất vọng',
  3: '😐 Bình thường - Ổn',
  4: '😊 Tốt - Hài lòng',
  5: '🤩 Xuất sắc - Rất hài lòng'
};

function highlightStars(rating) {
  starButtons.forEach((star, index) => {
    if (index < rating) {
      star.style.color = '#fbbf24';
      star.style.transform = 'scale(1.1)';
    } else {
      star.style.color = '#d1d5db';
      star.style.transform = 'scale(1)';
    }
  });
  
  // Highlight description
  ratingDescriptions.forEach(desc => {
    const descRating = parseInt(desc.getAttribute('data-rating'));
    if (descRating <= rating) {
      desc.style.opacity = '1';
      desc.style.background = 'var(--primary)';
      desc.style.color = '#06210e';
    } else {
      desc.style.opacity = '0.5';
      desc.style.background = 'var(--bg)';
      desc.style.color = 'var(--text)';
    }
  });
}

function resetStars() {
  if (selectedRating === 0) {
    starButtons.forEach(star => {
      star.style.color = '#d1d5db';
      star.style.transform = 'scale(1)';
    });
    
    ratingDescriptions.forEach(desc => {
      desc.style.opacity = '0.5';
      desc.style.background = 'var(--bg)';
      desc.style.color = 'var(--text)';
    });
    
    ratingFeedback.textContent = 'Nhấn vào ngôi sao để đánh giá';
  } else {
    highlightStars(selectedRating);
  }
}

function selectRating(rating) {
  selectedRating = rating;
  ratingInput.value = rating;
  ratingFeedback.textContent = ratingTexts[rating];
  ratingFeedback.style.color = rating >= 4 ? '#10b981' : rating >= 3 ? '#f59e0b' : '#ef4444';
  
  // Add animation
  ratingFeedback.style.transform = 'scale(1.05)';
  setTimeout(() => {
    ratingFeedback.style.transform = 'scale(1)';
  }, 200);
  
  highlightStars(rating);
}

// Character counter
function updateCharCount() {
  const textarea = document.getElementById('content');
  const charCount = document.getElementById('charCount');
  const count = textarea.value.length;
  
  charCount.textContent = count;
  
  if (count > 800) {
    charCount.style.color = '#ef4444';
  } else if (count > 600) {
    charCount.style.color = '#f59e0b';
  } else {
    charCount.style.color = 'var(--muted)';
  }
}

// Form validation
document.getElementById('reviewForm').addEventListener('submit', function(e) {
  if (selectedRating === 0) {
    e.preventDefault();
    alert('Vui lòng chọn đánh giá sao trước khi gửi!');
    return false;
  }
  
  const reviewer = document.getElementById('reviewer').value.trim();
  if (!reviewer) {
    e.preventDefault();
    alert('Vui lòng nhập tên của bạn!');
    return false;
  }
});

// Auto-save draft (optional)
let draftTimer;
document.getElementById('content').addEventListener('input', function() {
  clearTimeout(draftTimer);
  draftTimer = setTimeout(() => {
    // Save draft to localStorage
    const draft = {
      reviewer: document.getElementById('reviewer').value,
      rating: selectedRating,
      content: document.getElementById('content').value,
      reading_status: document.getElementById('reading-status').value,
      recommend: document.getElementById('recommend').value
    };
    localStorage.setItem('review_draft_{{ book.id }}', JSON.stringify(draft));
  }, 1000);
});

// Load draft on page load
window.addEventListener('load', function() {
  const draft = localStorage.getItem('review_draft_{{ book.id }}');
  if (draft) {
    const data = JSON.parse(draft);
    if (data.reviewer) document.getElementById('reviewer').value = data.reviewer;
    if (data.rating) selectRating(data.rating);
    if (data.content) document.getElementById('content').value = data.content;
    if (data.reading_status) document.getElementById('reading-status').value = data.reading_status;
    if (data.recommend) document.getElementById('recommend').value = data.recommend;
  }
});
</script>

{% endblock %}


